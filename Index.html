<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng Cử Viên và Bầu Cử</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/gh/lelinh014756/fui-toast-js@master/assets/css/toast@1.0.1/fuiToast.min.css">
    <script
        src="https://cdn.jsdelivr.net/gh/lelinh014756/fui-toast-js@master/assets/js/toast@1.0.1/fuiToast.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
</head>

<body>


    <!-- Thêm phần tử loading overlay -->
    <div id="loadingOverlay" style="display: none;">
        <div class="spinner"></div>
    </div>


    <div id="fui-toast"></div>

    <main>
        <div class="control-panel">
            <div class="search-sort-container">
                <input type="text" id="searchInput" placeholder="Tìm kiếm theo tên ứng viên">
                <select id="sortSelect">
                    <option value="votes">Sắp xếp theo số phiếu (cao đến thấp)</option>
                    <option value="name">Sắp xếp theo tên</option>
                </select>
            </div>
            <div class="pagination-container">
                <button id="prevPage"><i class="fas fa-chevron-left"></i> </button>
                <span id="pageInfo"></span>
                <button id="nextPage"> <i class="fas fa-chevron-right"></i></button>
                <button id="refreshButton"><i class="fas fa-sync-alt"></i></button>
            </div>
        </div>

        <div id="cardContainer" class="card-container"></div>
    </main>

    <div id="voteModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2><i class="fas fa-vote-yea"></i> Nhập ID Cử Tri</h2>
            <input type="text" id="voterIdInput" placeholder="Nhập IDCT">
            <button id="submitVoteButton"><i class="fas fa-check"></i> Xác nhận</button>
        </div>
    </div>

    <div id="memberInfoModal" class="modal-mask" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-close">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </div>
            <h2 class="modal-title">Thông tin hội viên</h2>
            <div class="modal-content" id="memberInfoContent"></div>
        </div>
    </div>

    <script>

        const appId = 'd457dee0-9328-402a-af94-cd3358dbad1c';
        const accessKey = 'V2-MHoFx-64XnM-FJO7E-521rK-jB06n-cU7bN-oq6bW-KNMRV';
        const region = 'www';
        let selectedCandidateId = '';
        let totalVotes = 0;
        let candidateVotes = {};
        let allCandidates = [];
        let currentPage = 1;
        const itemsPerPage = 4;

        function apiRequest(tableName, action, data) {
            const apiUrl = `https://${region}.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Action`;
            return $.ajax({
                url: apiUrl,
                method: 'POST',
                headers: {
                    'ApplicationAccessKey': accessKey,
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({
                    Action: action,
                    Properties: {
                        Locale: 'vi-VN',
                        Timezone: 'Asia/Ho_Chi_Minh'
                    },
                    ...data
                })
            });
        }

        function showLoading() {
            $('#loadingOverlay').show();
        }

        function hideLoading() {
            $('#loadingOverlay').hide();
        }

        function loadData() {
            showLoading();
            Promise.all([
                apiRequest('UngCuVien', 'Find', { Rows: [], Properties: { Selector: 'Filter(UngCuVien, true)' } }),
                apiRequest('PhieuBau', 'Find', { Rows: [], Properties: { Selector: 'Filter(PhieuBau, true)' } })
            ]).then(([candidates, votes]) => {
                processCandidatesAndVotes(candidates, votes);
                hideLoading();
            }).catch(error => {
                console.error('Lỗi khi tải dữ liệu:', error);
                hideLoading();
            });
        }

        function processCandidatesAndVotes(candidates, votes) {
            totalVotes = votes.length;
            candidateVotes = votes.reduce((acc, vote) => {
                acc[vote.IDUCV] = (acc[vote.IDUCV] || 0) + 1;
                return acc;
            }, {});

            allCandidates = candidates.map(candidate => ({
                ...candidate,
                votes: candidateVotes[candidate.IDUCV] || 0
            }));

            sortAndFilterCandidates();
        }

        function sortAndFilterCandidates() {
            let filteredCandidates = allCandidates;
            const searchTerm = $('#searchInput').val().toLowerCase();

            if (searchTerm) {
                filteredCandidates = filteredCandidates.filter(candidate =>
                    candidate['Họ Và Tên'].toLowerCase().includes(searchTerm)
                );
            }

            const sortBy = $('#sortSelect').val();
            filteredCandidates.sort((a, b) =>
                sortBy === 'votes' ? b.votes - a.votes : a['Họ Và Tên'].localeCompare(b['Họ Và Tên'])
            );

            const totalPages = Math.ceil(filteredCandidates.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const candidatesToShow = filteredCandidates.slice(startIndex, startIndex + itemsPerPage);

            displayCandidates(candidatesToShow);
            updatePagination(totalPages);
        }

        function displayCandidates(candidates) {
            const cardContainer = $('#cardContainer');
            cardContainer.empty();

            candidates.forEach(candidate => {
                const card = $('<div>').addClass('card');
                const votes = candidate.votes || 0;
                const percentage = totalVotes > 0 ? (votes / totalVotes * 100).toFixed(2) : 0;

                card.html(`
            <img src="https://www.appsheet.com/template/gettablefileurl?appName=Bầucử-612701497&tableName=UngCuVien&fileName=${candidate['Hình ảnh']}" alt="Ảnh ứng cử viên">
            <div class="card-content">
                <h2>${candidate['Họ Và Tên']}</h2>
                <p><i class="fas fa-id-card"></i> ID UCV: ${candidate.IDUCV}</p>
                <p><i class="fas fa-birthday-cake"></i> Ngày Sinh: ${candidate['Ngày Sinh']}</p>
                <p><i class="fas fa-map-marker-alt"></i> Tên doanh nghiệp: ${candidate['Tên doanh nghiệp']}</p>
                <p><i class="fas fa-id-badge"></i> Chức vụ trong DN: ${candidate['Chức vụ trong DN']}</p>
                <p><i class="fas fa-id-badge"></i> Chức vụ trong BIFA: ${candidate['Chức vụ trong BIFA']}</p>
                <div class="card-buttons">
                <button class="vote-btn"><i class="fas fa-vote-yea"></i>Bầu Cử</button>
                <button class="view-info-btn"><i class="fas fa-info-circle"></i>Xem thông tin</button>
            </div>
            </div>
        `);

                card.find('.vote-btn').click(() => {
                    selectedCandidateId = candidate.IDUCV;
                    openVoteModal();
                });

                card.find('.view-info-btn').click(() => showMemberInfo(candidate));

                cardContainer.append(card);
            });
        }

        function updatePagination(totalPages) {
            $('#pageInfo').text(`Trang ${currentPage} / ${totalPages}`);
            $('#prevPage').prop('disabled', currentPage === 1);
            $('#nextPage').prop('disabled', currentPage === totalPages);
        }

        function showMemberInfo(candidate) {
            const modal = $('#memberInfoModal');
            $('#memberInfoContent').html(`
        <p><img src="https://www.appsheet.com/template/gettablefileurl?appName=Bầucử-612701497&tableName=UngCuVien&fileName=${candidate['Hình ảnh']}" width="100px"></p>
        <p><strong>Họ và Tên:</strong> ${candidate['Họ Và Tên']}</p>
        <p><strong>ID UCV:</strong> ${candidate.IDUCV}</p>
        <p><strong>Tên doanh nghiệp:</strong> ${candidate['Tên doanh nghiệp']}</p>
        <p><strong>Chức vụ trong DN:</strong> ${candidate['Chức vụ trong DN']}</p>
        <p><strong>Ngành nghề kinh doanh:</strong> ${candidate['Ngành nghề kinh doanh']}</p>
        <p><strong>Chức vụ trong BIFA</strong> ${candidate['Chức vụ trong BIFA']}</p>
        <p><strong>Tiểu sử công tác</strong> ${candidate['Tiểu sử công tác']}</p>
        <p><strong>Thông tin cử viên:</strong> ${candidate['Thông tin cử viên']}</p>
    `);
            modal.css('display', 'flex').find('.modal-dialog').addClass('is-open');
        }

        function openVoteModal() {
            $('#voteModal').show();
        }

        function closeVoteModal() {
            $('#voteModal').hide();
        }

        function submitVote() {
            showLoading();
            const voterId = $('#voterIdInput').val();
            apiRequest('CuTri', 'Find', {
                Rows: [],
                Properties: { Selector: `Filter(CuTri, [IDCT] = "${voterId}")` }
            }).then(response => {
                if (response.length > 0) {
                    const voter = response[0];
                    if (voter['Trạng Thái'] === 'Đã bầu cử') {
                        FuiToast.info('Bạn đã bầu cử rồi');
                        closeVoteModal();
                    } else {
                        apiRequest('PhieuBau', 'Add', {
                            Rows: [{ IDCT: voterId, IDUCV: selectedCandidateId }]
                        }).then(() =>
                            apiRequest('CuTri', 'Edit', {
                                Rows: [{ IDCT: voterId, 'Trạng Thái': 'Đã bầu cử' }]
                            })
                        ).then(() => {
                            FuiToast.success('Bầu cử thành công.');
                            closeVoteModal();
                            loadData();
                        }).catch(() => FuiToast.error("Có lỗi xảy ra, vui lòng thử lại."));
                    }
                } else {
                    FuiToast.info('Mã ID cử tri của bạn không đúng, hoặc không có trên hệ thống.');
                }
                hideLoading();
            }).catch(() => {
                FuiToast.warning("Có lỗi xảy ra. Vui lòng thử lại.");
                hideLoading();
            });
        }

        $(document).ready(() => {
            loadData();
            setInterval(loadData, 30000);

            $('#refreshButton').click(loadData);
            $('.close').click(closeVoteModal);
            $('#searchInput').on('input', () => {
                currentPage = 1;
                sortAndFilterCandidates();
            });
            $('#sortSelect').change(() => {
                currentPage = 1;
                sortAndFilterCandidates();
            });
            $('#prevPage').click(() => {
                if (currentPage > 1) {
                    currentPage--;
                    sortAndFilterCandidates();
                }
            });
            $('#nextPage').click(() => {
                currentPage++;
                sortAndFilterCandidates();
            });

            $(window).click(event => {
                if (event.target == document.getElementById("voteModal")) {
                    closeVoteModal();
                }
            });

            $('#submitVoteButton').click(submitVote);

            $(document).on('click', '.view-info-btn', function () {
                const candidateId = $(this).closest('.card').find('p:contains("ID UCV:")').text().split(': ')[1];
                const candidate = allCandidates.find(c => c.IDUCV === candidateId);
                if (candidate) {
                    showMemberInfo(candidate);
                }
            });

            $('#memberInfoModal .modal-close').click(() => {
                const modal = $('#memberInfoModal');
                modal.find('.modal-dialog').removeClass('is-open');
                setTimeout(() => modal.css('display', 'none'), 400);
            });

            $('#memberInfoModal').click(function (event) {
                if (event.target === this) {
                    $(this).find('.modal-dialog').removeClass('is-open');
                    setTimeout(() => $(this).css('display', 'none'), 400);
                }
            });
        });

    </script>
</body>

</html>