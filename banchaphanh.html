<!DOCTYPE html>
<html lang="vi" class="bg-gray-100">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
    <title>Bầu cử Ban Chấp Hành</title>
    <link rel="shortcut icon" href="https://www.bifa.vn/Data/Sites/1/skins/default/favicon.ico" type="image/x-icon">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/gh/lelinh014756/fui-toast-js@master/assets/css/toast@1.0.1/fuiToast.min.css">
    <script
        src="https://cdn.jsdelivr.net/gh/lelinh014756/fui-toast-js@master/assets/js/toast@1.0.1/fuiToast.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #000;
        }

        #memberInfoModal {
            display: none;
        }

        .modal-mask {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-dialog {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #cardContainer {
            min-height: 400px;
        }

        .candidate-card {
            transition: all 0.3s ease-in-out;
        }

        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Nút màu xanh (Chọn, Đã chọn, Làm mới) */
        button.bg-blue-500 {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 14px;
            padding: 8px 16px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
        }

        button.bg-blue-500:hover {
            background-color: #0056b3;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 123, 255, 0.4);
        }

        /* Nút màu xanh lá (Xác nhận, Xem thông tin) */
        button.bg-green-500 {
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 14px;
            padding: 10px 20px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        button.bg-green-500:hover {
            background-color: #218838;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4);
        }

        /* Nút phân trang (Trái, Phải) */
        button.bg-gray-200 {
            background-color: #e2e6ea;
            color: #495057;
            border: none;
            border-radius: 30px;
            font-size: 14px;
            padding: 10px 20px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.2);
        }

        button.bg-gray-200:hover {
            background-color: #ced4da;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(108, 117, 125, 0.3);
        }

        /* Hiệu ứng khi bấm vào nút */
        button:active {
            transform: translateY(2px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        /* Thẻ ứng cử viên */
        .candidate-card {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .candidate-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }

        /* Hình ảnh ứng cử viên */
        .candidate-card img {
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            object-fit: contain;
            height: 300px;
            width: 100%;
        }

        /* Nội dung thẻ */
        .candidate-card .p-4 {
            padding: 20px;
            font-family: 'Roboto', sans-serif;
            color: #333;
        }

        /* Tiêu đề và tên ứng cử viên */
        .candidate-card h2 {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
            text-align: center;
        }

        /* Thông tin ứng cử viên */
        .candidate-card p {
            margin-bottom: 8px;
            color: #555;
            font-size: 14px;
            line-height: 1.5;
        }

        /* Icon và văn bản trong thẻ */
        .candidate-card p i {
            margin-right: 8px;
            color: #3498db;
        }

        /* Các nút chọn và xem thông tin */
        .candidate-card .select-btn,
        .candidate-card .view-info-btn {
            padding: 8px 12px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .candidate-card .select-btn {
            background-color: #007bff;
            /* Màu xanh dương */
            color: white;
            border: none;
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
        }

        .candidate-card .select-btn:hover {
            background-color: #0056b3;
            /* Xanh dương đậm khi hover */
            transform: translateY(-3px);
        }


        .candidate-card .select-btn.selected {
            background-color: #28a745;
            /* Màu xanh lá */
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2);
        }

        .candidate-card .select-btn.selected:hover {
            background-color: #218838;
            /* Xanh lá đậm khi hover */
            transform: translateY(-3px);
        }

        .candidate-card .view-info-btn {
            background-color: #ced4da;
            color: #495057;
            border: none;
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.2);
        }

        .candidate-card .view-info-btn:hover {
            background-color: #ced4da;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(108, 117, 125, 0.3);
        }

        #controlPanel {
            display: block;
        }
    </style>
</head>

<body class="font-sans">
    <div id="loadingOverlay" class="hidden">
        <div class="spinner"></div>
    </div>


    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4 text-center">Đăng Nhập</h2>
            <div class="mb-4">
                <label for="loginUsername" class="block text-sm font-medium text-gray-700 mb-1">Tên đăng nhập</label>
                <input type="text" id="loginUsername"
                    class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="mb-4">
                <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1">Mật khẩu</label>
                <input type="password" id="loginPassword"
                    class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="mb-4 flex items-center">
                <input type="checkbox" id="rememberLogin" class="mr-2">
                <label for="rememberLogin" class="text-sm text-gray-600">Ghi nhớ đăng nhập</label>
            </div>
            <button id="loginButton"
                class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-300 ease-in-out">
                Đăng nhập
            </button>
        </div>
    </div>

    <div id="fui-toast"></div>

    <!-- Member Info Modal -->
    <div class="InfoModal fixed bottom-4 right-4 z-50 flex flex-col gap-2">
        <button id="confirmVoteButton"
            class="bg-blue-500 hover:bg-blue-600 text-white rounded-full p-3 shadow-lg transition duration-300 ease-in-out">
            <i class="fas fa-paper-plane"></i>
        </button>
        <button id="selectedCountButton"
            class="bg-blue-500 hover:bg-blue-600 text-white rounded-full p-3 shadow-lg transition duration-300 ease-in-out">
            <span id="selectedCountText" class="text-sm font-medium">0</span>
        </button>

        <button id="refreshButton"
            class="bg-blue-500 hover:bg-blue-600 text-white rounded-full p-3 shadow-lg transition duration-300 ease-in-out">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>

    <main class="container mx-auto px-4">
        <div id="controlPanel"
            class="control-panel bg-white rounded-lg shadow-md p-6 mb-8 sticky top-0 z-40 transform transition-transform duration-300 ease-in-out md:translate-y-0">
            <div class="flex flex-col lg:flex-row items-center justify-between gap-4">
                <div class="flex flex-col sm:flex-row items-center gap-4 w-full lg:w-auto">
                    <div class="flex items-center gap-4">
                        <img src="https://www.bifa.vn/Data/Sites/1/skins/default/favicon.ico" alt="Bầu cử Ban chấp hành"
                            class="h-8 w-8">
                        <h1 class="text-2xl font-bold whitespace-nowrap">Bầu cử Ban chấp hành</h1>
                    </div>

                    <div class="search-sort-container w-full sm:w-64">
                        <form id="searchForm" class="w-full">
                            <input type="text" id="searchInput"
                                class="w-full px-4 py-2 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="Tìm kiếm ứng viên">
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div id="cardContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
    </main>

    <div id="selectedCandidatesModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 class="text-2xl font-bold mb-4 text-center">Ứng cử viên đã chọn</h2>
            <ul id="selectedCandidatesList" class="space-y-2"></ul>
        </div>
    </div>

    <div id="voteModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 class="text-2xl font-bold mb-4">Xác nhận bầu cử</h2>
            <p id="selectedCountText"></p>
            <button id="submitVoteButton"
                class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition duration-300 ease-in-out">
                <i class="fas fa-check mr-2"></i> Xác nhận bầu cử
            </button>
        </div>
    </div>

    <div id="memberInfoModal" class="modal-mask">
        <div class="modal-dialog">
            <div class="modal-close absolute top-2 right-2 cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </div>
            <h2 class="text-2xl font-bold mb-4 text-center">Thông tin hội viên</h2>
            <div id="memberInfoContent"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script>
        // Constants
        const appId = 'd457dee0-9328-402a-af94-cd3358dbad1c';
        const accessKey = 'V2-MHoFx-64XnM-FJO7E-521rK-jB06n-cU7bN-oq6bW-KNMRV';
        const region = 'www';
        const MIN_VOTES = 25;
        const MAX_VOTES = 27;

        // Global variables
        let allCandidates = [];
        let selectedCandidates = [];
        let currentFilteredCandidates = [];

        // Functions for localStorage management
        function saveSelectedCandidates() {
            localStorage.setItem('selectedCandidates', JSON.stringify(selectedCandidates));
        }

        function loadSelectedCandidates() {
            const saved = localStorage.getItem('selectedCandidates');
            return saved ? JSON.parse(saved) : [];
        }

        // API and Data Management
        function apiRequest(tableName, action, data) {
            const apiUrl = `https://${region}.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Action`;
            return $.ajax({
                url: apiUrl,
                method: 'POST',
                headers: {
                    'ApplicationAccessKey': accessKey,
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({
                    Action: action,
                    Properties: {
                        Locale: 'vi-VN',
                        Timezone: 'Asia/Ho_Chi_Minh'
                    },
                    ...data
                })
            });
        }



        // Thêm vào phần đầu với các constants
        const usersTableName = 'CuTri'; // Tên bảng chứa thông tin người dùng

        // Thêm biến để theo dõi trạng thái đăng nhập
        let currentUser = null;

        // Hàm kiểm tra đăng nhập
        function checkLoginStatus() {
            const savedUsername = localStorage.getItem('username');
            const savedToken = localStorage.getItem('loginToken');

            if (savedUsername && savedToken) {
                // Nếu đã có thông tin đăng nhập thì gọi autoLogin 1 lần
                autoLogin(savedUsername, savedToken);
            } else {
                // Nếu chưa có thông tin thì hiển thị form đăng nhập
                hideLoading(); // Ẩn loading nếu đang hiển thị
                showLoginModal();
            }
        }

        // Hàm hiển thị modal đăng nhập
        function showLoginModal() {
            $('#loginModal').show();
            // Ẩn nội dung chính
            $('main').hide();
        }

        // Hàm ẩn modal đăng nhập
        function hideLoginModal() {
            $('#loginModal').hide();
            // Hiện nội dung chính
            $('main').show();
        }

        // Hàm xử lý đăng nhập
        async function handleLogin() {
            const username = $('#loginUsername').val();
            const password = $('#loginPassword').val();
            const rememberMe = $('#rememberLogin').is(':checked');

            if (!username || !password) {
                FuiToast.info('Vui lòng nhập đầy đủ thông tin đăng nhập');
                return;
            }

            showLoading();

            try {
                const result = await apiRequest('CuTri', 'Find', {
                    Properties: {
                        Selector: `Filter(CuTri, and([username] = "${username}", [password] = "${password}"))`
                    }
                });

                if (result && Array.isArray(result) && result.length === 1) {
                    const user = result[0];
                    handleSuccessfulLogin(user, rememberMe);
                } else {
                    FuiToast.error('Tên đăng nhập hoặc mật khẩu không đúng');
                }
            } catch (error) {
                console.error('Login error:', error);
                FuiToast.error('Đã có lỗi xảy ra khi đăng nhập');
            } finally {
                hideLoading();
            }
        }

        // Hàm xử lý khi đăng nhập thành công
        function handleSuccessfulLogin(user, rememberMe) {
            if (user['Trạng Thái PB Ban Chấp Hành'] === 'Đã bầu cử') {
                FuiToast.info('Bạn đã hoàn thành bầu cử');
                return;
            }

            if (user['Tình trạng cử tri'] !== 'Hợp lệ') {
                FuiToast.error('Tài khoản không được phép truy cập');
                handleLogout();
                return;
            }

            currentUser = user;

            if (rememberMe) {
                localStorage.setItem('username', user.IDCT);
                localStorage.setItem('loginToken', 'token-' + Date.now());
            }

            // Xóa các UI elements cũ nếu có
            $('.InfoModal .flex .text-sm').remove();
            $('.InfoModal .flex button.bg-red-500').remove();

            // Thêm UI elements mới
            const userInfo = $('<div>')
                .addClass('text-sm text-gray-600 mr-4')
                .text(`Xin chào, ${user['Họ Và Tên']}`);

            const logoutBtn = $('<button>')
                .addClass('bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-full text-sm')
                .text('Đăng xuất')
                .click(handleLogout);

            // Thêm vào vị trí cuối của flex container trong InfoModal
            $('.InfoModal .flex:first').append(userInfo, logoutBtn);


            hideLoginModal();
            FuiToast.success('Đăng nhập thành công');
            loadData();
        }

        // Hàm xử lý đăng xuất
        function handleLogout() {
            localStorage.removeItem('username');
            localStorage.removeItem('loginToken');
            currentUser = null;
            selectedCandidates = [];
            saveSelectedCandidates();


            // Reset UI
            $('main').hide();
            $('#loginUsername').val('');
            $('#loginPassword').val('');
            $('#rememberLogin').prop('checked', false);

            showLoginModal();
            FuiToast.info('Đã đăng xuất');
        }

        // Hàm tự động đăng nhập
        async function autoLogin(username, token) {
            if (!username || !token) {
                showLoginModal();
                return;
            }

            showLoading();

            try {
                const result = await apiRequest('CuTri', 'Find', {
                    Properties: {
                        Selector: `Filter(CuTri, [IDCT] = "${username}")`
                    }
                });

                if (result && result.length === 1) {
                    handleSuccessfulLogin(result[0], true);
                } else {
                    // Nếu auto login thất bại thì xóa thông tin và hiện form đăng nhập
                    localStorage.removeItem('username');
                    localStorage.removeItem('loginToken');
                    showLoginModal();
                }
            } catch (error) {
                console.error('Auto login error:', error);
                localStorage.removeItem('username');
                localStorage.removeItem('loginToken');
                showLoginModal();
            } finally {
                hideLoading();
            }
        }

        function resetPage() {
            selectedCandidates = [];
            currentFilteredCandidates = [];
            $('#searchInput').val('');
            saveSelectedCandidates();
        }

        function loadData() {
            if (!currentUser) {
                showLoginModal();
                return;
            }

            showLoading();
            resetPage();  // Add this line
            Promise.all([
                apiRequest('UngCuVien', 'Find', { Rows: [], Properties: { Selector: 'Filter(UngCuVien, [Trạng thái]="Đã duyệt")' } }),
                apiRequest('PhieuBau', 'Find', { Rows: [], Properties: { Selector: 'Filter(PhieuBau, true)' } })
            ]).then(([candidates, votes]) => {
                processCandidatesAndVotes(candidates, votes);
                hideLoading();
            }).catch(error => {
                console.error('Lỗi khi tải dữ liệu:', error);
                hideLoading();
            });
        }

        function processCandidatesAndVotes(candidates, votes) {
            const candidateVotes = votes.reduce((acc, vote) => {
                acc[vote.IDUCV] = (acc[vote.IDUCV] || 0) + 1;
                return acc;
            }, {});

            allCandidates = candidates.map(candidate => ({
                ...candidate,
                votes: candidateVotes[candidate.IDUCV] || 0
            }));

            currentFilteredCandidates = [...allCandidates];
            updateCandidatesDisplay();
            updateUIWithSelectedCandidates();
        }

        // UI Management
        function showLoading() {
            $('#loadingOverlay').show();
        }

        function hideLoading() {
            $('#loadingOverlay').hide();
        }

        function updateCandidatesDisplay() {
            const candidatesToShow = currentFilteredCandidates;

            const cardContainer = $('#cardContainer');
            cardContainer.empty();

            candidatesToShow.forEach(candidate => {
                cardContainer.append(createCandidateCard(candidate));
            });

            updateUIWithSelectedCandidates();
            animateCards();
        }

        function createCandidateCard(candidate) {
            return $(`
            <div class="candidate-card bg-white rounded-lg shadow-md overflow-hidden transition-transform duration-300 hover:shadow-lg hover:-translate-y-1 flex flex-col h-full">
                <img src="${candidate['Hình ảnh']}" 
                     alt="Ảnh ứng cử viên" class="w-full h-48 object-cover">
                <div class="p-4 flex-grow">
                    <h2 class="text-xl font-bold mb-2">${candidate['Họ Và Tên']}</h2>
                    <p class="text-gray-600"><i class="fas fa-id-card mr-2"></i> ID UCV: ${candidate.IDUCV}</p>
                    <p class="text-gray-600"><i class="fas fa-birthday-cake mr-2"></i> Ngày Sinh: ${candidate['Ngày Sinh']}</p>
                    <p class="text-gray-600"><i class="fas fa-map-marker-alt mr-2"></i> Tên doanh nghiệp: ${candidate['Tên doanh nghiệp']}</p>
                    <p class="text-gray-600"><i class="fas fa-id-badge mr-2"></i> Chức vụ trong DN: ${candidate['Chức vụ trong DN']}</p>
                    <p class="text-gray-600"><i class="fas fa-id-badge mr-2"></i> Chức vụ trong BIFA: ${candidate['Chức vụ trong BIFA']}</p>
                </div>
                <div class="p-4 bg-gray-100 mt-auto">
                    <div class="grid grid-cols-2 gap-2">
                        <button class="select-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-300 ease-in-out text-sm" data-id="${candidate.IDUCV}">
                            Chọn
                        </button>
                        <button class="view-info-btn bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition duration-300 ease-in-out text-sm">
                            <i class="fas fa-info-circle mr-1"></i>Xem thông tin
                        </button>
                    </div>
                </div>
            </div>
        `);
        }

        function updateCandidateCard($card, candidate) {
            $card.find('img').attr('src', `${candidate['Hình ảnh']}`);
            $card.find('h2').text(candidate['Họ Và Tên']);
            $card.find('p:eq(0)').html(`<i class="fas fa-id-card mr-2"></i> ID UCV: ${candidate.IDUCV}`);
            $card.find('p:eq(1)').html(`<i class="fas fa-birthday-cake mr-2"></i> Ngày Sinh: ${candidate['Ngày Sinh']}`);
            $card.find('p:eq(2)').html(`<i class="fas fa-map-marker-alt mr-2"></i> Tên doanh nghiệp: ${candidate['Tên doanh nghiệp']}`);
            $card.find('p:eq(3)').html(`<i class="fas fa-id-badge mr-2"></i> Chức vụ trong DN: ${candidate['Chức vụ trong DN']}`);
            $card.find('p:eq(4)').html(`<i class="fas fa-id-badge mr-2"></i> Chức vụ trong BIFA: ${candidate['Chức vụ trong BIFA']}`);
            $card.find('.select-btn').data('id', candidate.IDUCV);
        }

        function animateCards() {
            anime({
                targets: '.candidate-card',
                scale: [0.9, 1],
                opacity: [0, 1],
                duration: 800,
                delay: anime.stagger(100),
                easing: 'easeOutElastic(1, .8)'
            });
        }

        function updateUIWithSelectedCandidates() {
            $('.select-btn').each(function () {
                const candidateId = $(this).data('id');
                if (selectedCandidates.includes(candidateId)) {
                    $(this).text('Đã chọn').addClass('bg-green-500').removeClass('bg-blue-500');
                } else {
                    $(this).text('Chọn').addClass('bg-blue-500').removeClass('bg-green-500');
                }
            });
            updateConfirmButton();
            updateSelectedCount();
        }


        function updateSelectedCount() {
            $('#selectedCountButton').text(`${selectedCandidates.length}`);
        }

        function updateConfirmButton() {
            $('#confirmVoteButton').toggle(selectedCandidates.length > 0);
        }

        // Modal functions
        function openSelectedCandidatesModal() {
            const modal = $('#selectedCandidatesModal');
            const list = $('#selectedCandidatesList');
            list.empty();

            selectedCandidates.forEach(candidateId => {
                const candidate = allCandidates.find(c => c.IDUCV === candidateId);
                if (candidate) {
                    const li = createSelectedCandidateListItem(candidate);
                    list.append(li);
                }
            });

            modal.show();
        }

        function createSelectedCandidateListItem(candidate) {
            const li = $('<li>').addClass('bg-gray-100 p-2 rounded flex justify-between items-center');
            const candidateInfo = $('<div>')
                .addClass('flex items-center cursor-pointer')
                .click(() => showMemberInfo(candidate));

            const img = $('<img>')
                .attr('src', `${candidate['Hình ảnh']}`)
                .attr('alt', candidate['Họ Và Tên'])
                .addClass('w-10 h-10 rounded-full mr-2 object-cover');

            const nameSpan = $('<span>')
                .addClass('font-semibold')
                .text(candidate['Họ Và Tên']);

            const removeButton = $('<button>')
                .addClass('bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded text-sm transition duration-300 ease-in-out')
                .text('Xóa')
                .click((e) => {
                    e.stopPropagation();
                    removeSelectedCandidate(candidate.IDUCV);
                });

            candidateInfo.append(img, nameSpan);
            li.append(candidateInfo, removeButton);
            return li;
        }

        function removeSelectedCandidate(candidateId) {
            selectedCandidates = selectedCandidates.filter(id => id !== candidateId);
            saveSelectedCandidates();
            updateUIWithSelectedCandidates();
            openSelectedCandidatesModal();
        }

        function showMemberInfo(candidate) {
            const modal = $('#memberInfoModal');
            $('#memberInfoContent').html(`
            <div class="space-y-4">
                <img src="${candidate['Hình ảnh']}" 
                     alt="${candidate['Họ Và Tên']}" class="w-56 rounded-full mx-auto">
                <p class="text-xl font-bold text-center">${candidate['Họ Và Tên']}</p>
                <p><strong>ID UCV:</strong> ${candidate.IDUCV}</p>
                <p><strong>Tên doanh nghiệp:</strong> ${candidate['Tên doanh nghiệp']}</p>
                <p><strong>Chức vụ trong DN:</strong> ${candidate['Chức vụ trong DN']}</p>
                <p><strong>Ngành nghề kinh doanh:</strong> ${candidate['Ngành nghề kinh doanh']}</p>
                <p><strong>Chức vụ trong BIFA:</strong> ${candidate['Chức vụ trong BIFA']}</p>
                <p><strong>Tiểu sử công tác:</strong> ${candidate['Tiểu sử công tác']}</p>
                <p><strong>Thông tin giới thiệu bản thân:</strong> ${candidate['Thông tin giới thiệu bản thân'] || "Không có"}</p>
            </div>
        `);
            modal.css('display', 'flex');
            modal.find('.modal-dialog').addClass('is-open');
        }

        // Voting Process
        function confirmVote() {
            if (selectedCandidates.length < MIN_VOTES) {
                FuiToast.info(`Vui lòng chọn ít nhất ${MIN_VOTES} ứng cử viên.`);
                return;
            }
            if (selectedCandidates.length > MAX_VOTES) {
                FuiToast.info(`Vui lòng chọn tối đa ${MAX_VOTES} ứng cử viên.`);
                return;
            }

            // Cập nhật text hiển thị số lượng đã chọn
            $('#selectedCountText').text(`Bạn đã chọn ${selectedCandidates.length} ứng cử viên`);

            $('#voteModal').show();
        }

        async function submitVote() {

            if (!currentUser) {
                FuiToast.error('Vui lòng đăng nhập để thực hiện bầu cử');
                showLoginModal();
                return;
            }

            const voterId = currentUser.IDCT;
            if (!voterId) {
                FuiToast.info('Vui lòng nhập mã ID cử tri.');
                return;
            }

            $('#voteModal').hide();
            showLoading();

            try {
                const voters = await apiRequest('CuTri', 'Find', {
                    Rows: [],
                    Properties: { Selector: `Filter(CuTri, [IDCT] = "${voterId}")` }
                });

                if (voters.length === 0) {
                    throw new Error('Invalid voter ID');
                }

                const voter = voters[0];
                if (voter['Tình trạng cử tri'] !== 'Hợp lệ') {
                    FuiToast.info('Bạn không đủ điều kiện để bầu cử');
                    return;
                }
                if (voter['Trạng Thái PB Ban Chấp Hành'] === 'Đã bầu cử') {
                    FuiToast.info('Bạn đã bầu cử rồi');
                    return;
                }

                const phieuBauRows = selectedCandidates.map(candidateId => ({
                    IDCT: voterId,
                    IDUCV: candidateId
                }));

                await apiRequest('PhieuBau', 'Add', { Rows: phieuBauRows });
                await apiRequest('CuTri', 'Edit', {
                    Rows: [{ IDCT: voterId, 'Trạng Thái PB Ban Chấp Hành': 'Đã bầu cử' }]
                });

                FuiToast.success('Bầu cử thành công.');
                selectedCandidates = [];
                saveSelectedCandidates();
                updateUIWithSelectedCandidates();
                setTimeout(() => location.reload(), 2000);

            } catch (error) {
                console.error('Error during voting process:', error);
                if (error.message === 'Invalid voter ID') {
                    FuiToast.info('Mã ID cử tri của bạn không đúng, hoặc không có trên hệ thống.');
                } else {
                    FuiToast.error("Có lỗi xảy ra, vui lòng thử lại.");
                }
            } finally {
                hideLoading();
            }
        }

        // Search and Filter
        function handleSearch() {
            const searchTerm = $('#searchInput').val().toLowerCase().trim();
            currentFilteredCandidates = allCandidates.filter(candidate =>
                candidate['Họ Và Tên'].toLowerCase().includes(searchTerm) ||
                candidate.IDUCV.toLowerCase().includes(searchTerm) ||
                candidate['Tên doanh nghiệp'].toLowerCase().includes(searchTerm)
            );
        }

        // Utility functions
        function throttle(func, limit) {
            let inThrottle;
            return function () {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            }
        }


        // Event Listeners
        $(document).ready(() => {
            // Ẩn main content ban đầu
            $('main').hide();

            // Kiểm tra đăng nhập 1 lần khi load trang
            checkLoginStatus();

            // Event listeners cho đăng nhập
            $('#loginButton').click(handleLogin);

            // Cho phép đăng nhập bằng Enter key
            $('#loginPassword').keypress((e) => {
                if (e.which === 13) handleLogin();
            });

            // Event listeners cho search và filter
            $('#searchForm').on('submit', (e) => {
                e.preventDefault();
                handleSearch();
            });

            $('#searchInput').off('input').on('input', throttle(handleSearch, 300));

            // Event listeners cho bầu cử
            $('#confirmVoteButton').click(confirmVote);
            $('#selectedCountButton').click(openSelectedCandidatesModal);
            $('#submitVoteButton').click(submitVote);
            $('#refreshButton').click(() => {
                if (currentUser) {
                    loadData();
                }
            });

            // Event listeners cho xem thông tin ứng viên
            $(document).on('click', '.view-info-btn', function () {
                const candidateId = $(this).closest('.candidate-card').find('p:contains("ID UCV:")').text().split(': ')[1];
                const candidate = allCandidates.find(c => c.IDUCV === candidateId);
                if (candidate) {
                    showMemberInfo(candidate);
                }
            });

            // Event listener cho chọn ứng viên
            $(document).on('click', '.select-btn', function () {
                const candidateId = $(this).data('id');
                if (selectedCandidates.includes(candidateId)) {
                    selectedCandidates = selectedCandidates.filter(id => id !== candidateId);
                    $(this).text('Chọn').removeClass('selected').addClass('bg-blue-500');
                } else {
                    if (selectedCandidates.length >= MAX_VOTES) {
                        FuiToast.info(`Bạn đã chọn tối đa ${MAX_VOTES} ứng cử viên.`);
                        return;
                    }
                    selectedCandidates.push(candidateId);
                    $(this).text('Đã chọn').addClass('selected').removeClass('bg-blue-500');
                }
                saveSelectedCandidates();
                updateConfirmButton();
                updateSelectedCount();
            });

            // Event listeners cho đóng modal
            $('.close, .modal-close').click(function () {
                $(this).closest('.modal, .modal-mask').hide();
            });

            // Animation cho buttons
            $('button').on('mouseenter', function () {
                anime({
                    targets: this,
                    scale: 1.05,
                    duration: 300,
                    easing: 'easeOutElastic(1, .8)'
                });
            }).on('mouseleave', function () {
                anime({
                    targets: this,
                    scale: 1,
                    duration: 300,
                    easing: 'easeOutElastic(1, .8)'
                });
            });

            // Xử lý responsive controlPanel
            let isControlPanelVisible = false;
        });
    </script>
</body>

</html>