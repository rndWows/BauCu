<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kết Quả Bầu Cử - Cập Nhật Tự Động</title>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f4f8;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: #3498db;
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 700;
        }

        #totalVotes {
            font-size: 1.2em;
            margin: 20px 0;
            padding: 15px;
            background-color: #ecf0f1;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #lastUpdate {
            font-size: 0.9em;
            color: #7f8c8d;
            text-align: center;
            margin-bottom: 20px;
        }

        #chartContainer {
            width: 100%;
            height: 500px;
            margin-bottom: 30px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background-color: #3498db;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tr:hover {
            background-color: #e8f4fd;
        }

        button {
            display: inline-block;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: 700;
            color: white;
            background-color: #2ecc71;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 20px 0;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #27ae60;
        }

        button:focus {
            outline: none;
        }

        .sync-btn {
            background-color: #3498db;
            margin-left: 10px;
        }

        .sync-btn:hover {
            background-color: #2980b9;
        }

        .position-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .position-button {
            padding: 5px 10px;
            border: 1px solid #3498db;
            border-radius: 20px;
            background-color: white;
            color: #3498db;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .position-button.active {
            background-color: #3498db;
            color: white;
        }

        .position-button:hover {
            background-color: #e8f4fd;
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }

            th,
            td {
                padding: 10px 8px;
            }

            #chartContainer {
                height: 400px;
            }
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <div class="container">
        <div id="totalVotes"></div>
        <div id="lastUpdate"></div>
        <div id="chartContainer"></div>
        <button id="exportExcel">Xuất Excel</button>
        <button id="syncData" class="sync-btn">Đồng bộ dữ liệu</button>

        <table id="resultsTable">
            <thead>
                <tr>
                    <th>Top</th>
                    <th>Mã ứng viên</th>
                    <th>Họ và Tên</th>
                    <th>Hình ảnh ứng viên</th>
                    <th>Số phiếu bầu</th>
                    <th>Tỷ lệ</th>
                    <th>Vị trí ứng cử</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <!-- Modal cho chi tiết ứng viên -->
    <div id="candidateModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalTitle"></h2>
            <div id="modalContent"></div>
        </div>
    </div>
    <script>
        const appId = 'd457dee0-9328-402a-af94-cd3358dbad1c';
        const accessKey = 'V2-MHoFx-64XnM-FJO7E-521rK-jB06n-cU7bN-oq6bW-KNMRV';
        const region = 'www';
        let chart;
        let electionResults = [];
        let tempChanges = {};

        const positions = ['Chủ tịch', 'Phó chủ tịch', 'Ủy viên', 'Thư ký', 'Khác'];

        function apiRequest(tableName, action, data) {
            const apiUrl = `https://${region}.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Action`;
            return $.ajax({
                url: apiUrl,
                method: 'POST',
                headers: {
                    'ApplicationAccessKey': accessKey,
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({
                    Action: action,
                    Properties: {
                        Locale: 'vi-VN',
                        Timezone: 'Asia/Ho_Chi_Minh'
                    },
                    ...data
                })
            });
        }

        function loadData() {
            Promise.all([
                apiRequest('UngCuVien', 'Find', { Rows: [], Properties: { Selector: 'Filter(UngCuVien, true)' } }),
                apiRequest('PhieuBau', 'Find', { Rows: [], Properties: { Selector: 'Filter(PhieuBau, true)' } })
            ]).then(([candidates, votes]) => {
                processCandidatesAndVotes(candidates, votes);
            }).catch(error => console.error('Lỗi khi tải dữ liệu:', error));
        }

        function processCandidatesAndVotes(candidates, votes) {
            const totalVotes = votes.length;
            const candidateVotes = votes.reduce((acc, vote) => {
                acc[vote.IDUCV] = (acc[vote.IDUCV] || 0) + 1;
                return acc;
            }, {});

            const electionResultsData = candidates.map(candidate => ({
                id: candidate['IDUCV'],
                name: candidate['Họ Và Tên'],
                hinhanh: candidate['Hình ảnh'],
                ngaysinh: candidate['Ngày Sinh'],
                position: candidate['Vị trí ứng cử'],
                votes: candidateVotes[candidate.IDUCV] || 0,
                percentage: ((candidateVotes[candidate.IDUCV] || 0) / totalVotes * 100).toFixed(2)
            })).sort((a, b) => b.votes - a.votes);

            // Áp dụng các thay đổi tạm thời
            electionResultsData.forEach(candidate => {
                if (tempChanges[candidate.id]) {
                    candidate.position = tempChanges[candidate.id].join(', ');
                }
            });

            updateUI(totalVotes, electionResultsData);
        }

        function updateUI(totalVotes, results) {
            electionResults = results;
            $('#totalVotes').text(`Tổng số lượt bầu cử: ${totalVotes}`);
            $('#lastUpdate').text(`Cập nhật lần cuối: ${new Date().toLocaleString('vi-VN')}`);
            updateChart(results);
            updateTable(results);
        }

        function updateChart(data) {
            if (chart) {
                chart.series[0].setData(data.map(item => ({ name: item.name, y: item.votes })));
            } else {
                chart = Highcharts.chart('chartContainer', {
                    chart: {
                        type: 'column',
                        animation: Highcharts.svg,
                        marginRight: 10
                    },
                    title: {
                        text: 'Kết Quả Bầu Cử'
                    },
                    xAxis: {
                        type: 'category',
                        labels: {
                            rotation: -45,
                            style: {
                                fontSize: '13px',
                                fontFamily: 'Roboto, sans-serif'
                            }
                        }
                    },
                    yAxis: {
                        title: {
                            text: 'Số phiếu bầu '
                        }
                    },
                    legend: {
                        enabled: false
                    },
                    tooltip: {
                        pointFormat: '<b>{point.y} phiếu</b> ({point.percentage:.1f}%)'
                    },
                    series: [{
                        name: 'Số lượt bầu cử',
                        data: data.map(item => ({ name: item.name, y: item.votes, percentage: parseFloat(item.percentage) })),
                        dataLabels: {
                            enabled: true,
                            format: '{point.y}',
                            style: {
                                fontSize: '13px',
                                fontFamily: 'Roboto, sans-serif'
                            }
                        }
                    }]
                });
            }
        }

        function updateTable(data) {
            const tableBody = $('#resultsTable tbody');
            tableBody.empty();
            data.forEach((item, index) => {
                const positionButtons = positions.map(pos =>
                    `<button class="position-button ${item.position && item.position.includes(pos) ? 'active' : ''}" 
                     data-position="${pos}">${pos}</button>`
                ).join('');

                tableBody.append(`
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.id}</td>
                        <td>${item.name}</td>
                        <td><img src="https://www.appsheet.com/template/gettablefileurl?appName=Bầucử-612701497&tableName=UngCuVien&fileName=${item.hinhanh}" width="50px" alt="Ảnh ứng cử viên"></td>
                        <td>${item.votes}</td>
                        <td>${item.percentage}%</td>
                        <td>
                            <div class="position-buttons" data-id="${item.id}">
                                ${positionButtons}
                            </div>
                        </td>
                        <td>
                            <button class="detail-btn" data-id="${item.id}">Xem chi tiết</button>
                        </td>
                    </tr>
                `);
            });

            // Thêm event listener cho các nút vị trí
            $('.position-button').on('click', function() {
                const candidateId = $(this).closest('.position-buttons').data('id');
                const position = $(this).data('position');
                $(this).toggleClass('active');
                
                const selectedPositions = $(this).closest('.position-buttons').find('.position-button.active').map(function() {
                    return $(this).data('position');
                }).get();
                
                tempChanges[candidateId] = selectedPositions;
            });
        }

        function showCandidateDetails(candidateId) {
            const candidate = electionResults.find(c => c.id === candidateId);
            if (candidate) {
                $('#modalTitle').text(candidate.name);
                $('#modalContent').html(`
                    <p><strong>Mã ứng viên:</strong> ${candidate.id}</p>
                    <p><strong>Số phiếu bầu:</strong> ${candidate.votes}</p>
                    <p><strong>Tỷ lệ:</strong> ${candidate.percentage}%</p>
                    <p><strong>Ngày sinh:</strong> ${candidate.ngaysinh}</p>
                    <p><strong>Vị trí ứng cử:</strong> ${candidate.position || 'Chưa có'}</p>
                    <img src="https://www.appsheet.com/template/gettablefileurl?appName=Bầucử-612701497&tableName=UngCuVien&fileName=${candidate.hinhanh}" alt="Ảnh ứng cử viên" style="max-width: 200px;">
                `);
                $('#candidateModal').css('display', 'block');
            }
        }

        function syncDataToDatabase() {
            const updates = Object.entries(tempChanges).map(([id, positions]) => ({
                IDUCV: id,
                'Vị trí ứng cử': positions.join(', ')
            }));

            if (updates.length > 0) {
                apiRequest('UngCuVien', 'Edit', { Rows: updates })
                    .then(() => {
                        alert('Dữ liệu đã được đồng bộ thành công!');
                        tempChanges = {};
                        loadData(); // Tải lại dữ liệu sau khi đồng bộ
                    })
                    .catch(error => {
                        console.error('Lỗi khi đồng bộ dữ liệu:', error);
                        alert('Có lỗi xảy ra khi đồng bộ dữ liệu. Vui lòng thử lại.');
                    });
            } else {
                alert('Không có thay đổi nào để đồng bộ.');
            }
        }

        function exportToExcel(results) {
            // Chỉ lấy 50 người có số phiếu nhiều nhất
            const top50Results = results.slice(0, 50);

            // Tạo dữ liệu cho Excel
            const data = top50Results.map((item, index) => ({
                'STT': index + 1,
                'Họ và Tên': item.name,
                'Số Lượt Bầu Cử': item.votes,
                'Tỷ Lệ': item.percentage + '%'
            }));

            // Tạo worksheet từ dữ liệu
            const worksheet = XLSX.utils.json_to_sheet(data);

            // Tạo workbook và thêm worksheet vào
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Kết Quả Bầu Cử');

            // Xuất file Excel
            XLSX.writeFile(workbook, 'ket_qua_bau_cu.xlsx');
        }

        function startAutoUpdate() {
            loadData();
            setInterval(loadData, 3000);
        }

        $(document).ready(() => {
            startAutoUpdate();

            $('#syncData').click(syncDataToDatabase);

            $('#exportExcel').click(() => exportToExcel(electionResults));

            $(document).on('click', '.detail-btn', function () {
                const candidateId = $(this).data('id');
                showCandidateDetails(candidateId);
            });

            $('.close').click(() => {
                $('#candidateModal').css('display', 'none');
            });

            $(window).click((event) => {
                if (event.target == document.getElementById('candidateModal')) {
                    $('#candidateModal').css('display', 'none');
                }
            });
        });
    </script>
</body>
</html>